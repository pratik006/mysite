<div>
	<div class="form-group">
		<label for="comment">Comment:</label>
		<textarea id="msg" class="form-control" rows="10" maxlength="150"></textarea>
	</div>
	<div>
		<button id="send" type="button" class="button buttonBlue">Send
			<div class="ripples buttonRipples"><span class="ripplesCircle"></span></div>
		</button>
		<button id="refresh" type="button" class="button buttonBlue">Refresh
			<div class="ripples buttonRipples"><span class="ripplesCircle"></span></div>
		</button>
	</div>
</div>

<ul class="collection">
    
</ul>

<script type="text/javascript">
	
	$('#send').click(function() {
      console.log('clicked');
      $.get('/chat/add',
        {'msg': $('#msg').val(), 'lastIndex': lastIndex},
        function(result) {
          updateMessages(result);
        }
        );
    });
    $('#refresh').click(function() {
      $.get(
        '/chat/get',
        {'lastIndex': lastIndex},
        function(result) {
          updateMessages(result);
        }
      );  
    });

    function updateMessages(msgResponse) {
      lastIndex = msgResponse.lastIndex;
      
      $.get('msg-template.html', function(template){
          var temp = template;
          msgResponse.messages.forEach(function(message, index) {
            $(temp).find('span').text(new Date(message.time).toLocaleTimeString());
            console.log(message);
            $('.collection').append($(temp).html().replace('<p>','<p>'+message.msg));
          });
      });

      
    }

    function myLoop () {
      setTimeout(function () {  
        $.get(
          '/chat/get',
          {'lastIndex': lastIndex},
          function(result) {
            updateMessages(result);
          }
        );
        if (refreshTime <= 60000) {
          refreshTime += refreshTime; 
        }
        
        myLoop();
      }, refreshTime)
    }

    myLoop(); 
</script>